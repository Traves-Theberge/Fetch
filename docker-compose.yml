# Fetch - Docker Compose Configuration
# Dual-container architecture: Bridge (Brain) + Kennel (Muscle)

services:
  # The Bridge - WhatsApp orchestration layer
  fetch-bridge:
    build:
      context: .
      dockerfile: fetch-app/Dockerfile
    container_name: fetch-bridge
    restart: unless-stopped
    env_file:
      - .env
    # ─── Pipeline Tuning (uncomment to override defaults) ─────
    # environment:
    #   # Context Window
    #   - FETCH_HISTORY_WINDOW=20              # Messages in sliding window
    #   - FETCH_COMPACTION_THRESHOLD=40        # Compact when messages exceed this
    #   # Agent LLM
    #   - FETCH_CHAT_MAX_TOKENS=300            # Token budget for chat responses
    #   - FETCH_TOOL_MAX_TOKENS=500            # Token budget for tool responses
    #   - FETCH_CHAT_TEMPERATURE=0.7           # Chat creativity (0.0-1.0)
    #   - FETCH_TOOL_TEMPERATURE=0.3           # Tool precision (0.0-1.0)
    #   - FETCH_MAX_TOOL_CALLS=5               # Tool call rounds per message
    #   # Rate Limiting
    #   - FETCH_RATE_LIMIT_MAX=30              # Requests per window
    #   - FETCH_RATE_LIMIT_WINDOW=60000        # Window duration (ms)
    #   # Timeouts
    #   - FETCH_TASK_TIMEOUT=300000            # Task execution (ms)
    #   - FETCH_HARNESS_TIMEOUT=300000         # AI harness (ms)
    ports:
      # Status API for Go TUI (also serves docs)
      - "8765:8765"
    volumes:
      # Persistent data (WhatsApp auth, task database)
      - ./data:/app/data
      # Docker socket for controlling Kennel
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Shared workspace for file operations
      - ./workspace:/workspace
    depends_on:
      - fetch-kennel
    networks:
      - fetch-network

  # The Kennel - AI CLI execution sandbox
  fetch-kennel:
    build:
      context: ./kennel
      dockerfile: Dockerfile
    container_name: fetch-kennel
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      # Shared workspace for code operations
      - ./workspace:/workspace
      # CLI Authentication (mounted from host, read-only)
      # Only mount directories that exist on host
      - ~/.config/gh:/root/.config/gh:ro
      - ~/.config/claude-code:/root/.config/claude-code:ro
      - ~/.gemini:/root/.gemini:ro
    working_dir: /workspace
    # Keep container running for exec commands
    command: ["tail", "-f", "/dev/null"]
    networks:
      - fetch-network
    # Security: Limit resources
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'

networks:
  fetch-network:
    driver: bridge
